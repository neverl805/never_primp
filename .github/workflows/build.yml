name: Build and Publish never_primp

on:
  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      publish_to_pypi:
        description: 'æ˜¯å¦å‘å¸ƒåˆ° PyPI (true/false)'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

  # æ¨é€è§¦å‘ï¼štag æˆ–åˆ†æ”¯
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main
      - master

permissions:
  contents: read

jobs:
  # ==================== Linux å¹³å°æ„å»º ====================
  build-linux:
    name: Build Linux ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64        # Linux x64 (æœ€å¸¸ç”¨)
          - aarch64       # Linux ARM64 (æœåŠ¡å™¨)
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies (common)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libclang-dev \
            clang \
            cmake \
            build-essential \
            pkg-config \
            libssl-dev

      - name: Find and set libclang path
        run: |
          # æŸ¥æ‰¾ libclang.so å¹¶è®¾ç½®ç¯å¢ƒå˜é‡
          LIBCLANG_PATH=$(find /usr/lib -name "libclang.so*" | head -1 | xargs dirname)
          echo "LIBCLANG_PATH=$LIBCLANG_PATH" >> $GITHUB_ENV
          echo "Found libclang at: $LIBCLANG_PATH"
          ls -la $LIBCLANG_PATH/libclang.so* || true

      - name: Install aarch64 cross-compilation tools
        if: matrix.target == 'aarch64'
        run: |
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            libc6-dev-arm64-cross

      - name: Set aarch64 environment variables
        if: matrix.target == 'aarch64'
        run: |
          echo "CC=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CXX=aarch64-linux-gnu-g++" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "BINDGEN_EXTRA_CLANG_ARGS=--sysroot=/usr/aarch64-linux-gnu" >> $GITHUB_ENV

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        env:
          CC: ${{ matrix.target == 'aarch64' && 'aarch64-linux-gnu-gcc' || '' }}
          CXX: ${{ matrix.target == 'aarch64' && 'aarch64-linux-gnu-g++' || '' }}
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: ${{ matrix.target == 'aarch64' && 'aarch64-linux-gnu-gcc' || '' }}
          BINDGEN_EXTRA_CLANG_ARGS: ${{ matrix.target == 'aarch64' && '--sysroot=/usr/aarch64-linux-gnu' || '' }}
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'
          manylinux: ${{ matrix.target == 'x86_64' && '2_28' || 'off' }}
          before-script-linux: |
            # æ£€æµ‹åŒ…ç®¡ç†å™¨å¹¶å®‰è£…ä¾èµ–
            if command -v yum &> /dev/null; then
              echo "Using yum (manylinux container)"
              yum install -y clang-devel llvm-devel cmake
            elif command -v apt-get &> /dev/null; then
              echo "Using apt-get (Ubuntu host)"
              # ä¾èµ–å·²åœ¨ä¸»æœºå®‰è£…ï¼Œæ— éœ€é‡å¤
              echo "Dependencies already installed on host"
            fi

            # æŸ¥æ‰¾å¹¶è®¾ç½® libclang (ä½¿ç”¨å‚æ•°å±•å¼€é¿å…æœªç»‘å®šå˜é‡é”™è¯¯)
            export LIBCLANG_PATH="${LIBCLANG_PATH:-$(find /usr/lib* -name "libclang.so*" 2>/dev/null | head -1 | xargs dirname 2>/dev/null || echo "/usr/lib64")}"
            echo "Using LIBCLANG_PATH=$LIBCLANG_PATH"

            # éªŒè¯
            ls -la $LIBCLANG_PATH/libclang* 2>/dev/null || echo "libclang not found, relying on system defaults"
            clang --version 2>/dev/null || echo "clang not in PATH"

      - name: List built wheels
        run: ls -lh dist/

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.target }}
          path: dist

  # ==================== Windows å¹³å°æ„å»º ====================
  build-windows:
    name: Build Windows ${{ matrix.target }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        target: [x64]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: ${{ matrix.target }}

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'

      - name: List built wheels
        run: dir dist

      - name: Debug wheel contents
        shell: powershell
        run: |
          $wheel = Get-ChildItem dist\*.whl | Select-Object -First 1
          Write-Host "=== Wheel contents ==="
          python -m zipfile -l $wheel
          Write-Host "`n=== Looking for never_primp files ==="
          python -m zipfile -l $wheel | Select-String "never_primp"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-${{ matrix.target }}
          path: dist

  # ==================== macOS å¹³å°æ„å»º ====================
  build-macos:
    name: Build macOS ${{ matrix.target }}
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64        # Intel Mac
          - aarch64       # Apple Silicon (M1/M2/M3)
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'

      - name: List built wheels
        run: ls -lh dist/

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.target }}
          path: dist

  # ==================== æ„å»ºæºç åˆ†å‘åŒ… ====================
  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist

      - name: List sdist
        run: ls -lh dist/

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: dist

  # ==================== å‘å¸ƒåˆ° PyPI ====================
  publish-to-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos, build-sdist]

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: List all packages
        run: |
          echo "========================================="
          echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒçš„æ‰€æœ‰åŒ…ï¼š"
          echo "========================================="
          ls -lh dist/
          echo ""
          echo "========================================="
          echo "ğŸ“‹ åŒ…åˆ—è¡¨ï¼š"
          echo "========================================="
          for file in dist/*; do
            echo "  âœ“ $(basename $file)"
          done
          echo ""
          echo "========================================="

      - name: Publish to PyPI
        uses: PyO3/maturin-action@v1
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        with:
          command: upload
          args: --non-interactive --skip-existing dist/*

      - name: Success message
        run: |
          echo "========================================="
          echo "âœ… å‘å¸ƒæˆåŠŸï¼"
          echo "========================================="
          echo "ç”¨æˆ·ç°åœ¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š"
          echo "  pip install never_primp"
          echo ""
          echo "æŸ¥çœ‹é¡¹ç›®ï¼š"
          echo "  https://pypi.org/project/never_primp/"
          echo "========================================="