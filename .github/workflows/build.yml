name: Build and Publish never_primp

on:
  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      publish_to_pypi:
        description: 'æ˜¯å¦å‘å¸ƒåˆ° PyPI (true/false)'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

  # å½“æ¨é€ tag æ—¶è‡ªåŠ¨è§¦å‘å¹¶å‘å¸ƒ
  push:
    tags:
      - 'v*.*.*'

  # æ¨é€åˆ° main åˆ†æ”¯æ—¶ä»…æ„å»ºä¸å‘å¸ƒ
  push:
    branches:
      - main
      - master

permissions:
  contents: read

jobs:
  # ==================== Linux å¹³å°æ„å»º ====================
  build-linux:
    name: Build Linux ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64        # Linux x64 (æœ€å¸¸ç”¨)
          - aarch64       # Linux ARM64 (æœåŠ¡å™¨)
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'
          manylinux: auto

      - name: List built wheels
        run: ls -lh dist/

      - name: Test wheel (x86_64 only)
        if: matrix.target == 'x86_64'
        run: |
          pip install never_primp --no-index --find-links dist --force-reinstall
          python -c "import never_primp; print('âœ… Import test passed')"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.target }}
          path: dist

  # ==================== Windows å¹³å°æ„å»º ====================
  build-windows:
    name: Build Windows ${{ matrix.target }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        target: [x64]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: ${{ matrix.target }}

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'

      - name: List built wheels
        run: dir dist

      - name: Test wheel
        run: |
          pip install never_primp --no-index --find-links dist --force-reinstall
          python -c "import never_primp; print('âœ… Import test passed')"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-${{ matrix.target }}
          path: dist

  # ==================== macOS å¹³å°æ„å»º ====================
  build-macos:
    name: Build macOS ${{ matrix.target }}
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64        # Intel Mac
          - aarch64       # Apple Silicon (M1/M2/M3)
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'

      - name: List built wheels
        run: ls -lh dist/

      - name: Test wheel (x86_64 only)
        if: matrix.target == 'x86_64'
        run: |
          pip install never_primp --no-index --find-links dist --force-reinstall
          python -c "import never_primp; print('âœ… Import test passed')"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.target }}
          path: dist

  # ==================== æ„å»ºæºç åˆ†å‘åŒ… ====================
  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist

      - name: List sdist
        run: ls -lh dist/

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: dist

  # ==================== å‘å¸ƒåˆ° PyPI ====================
  publish-to-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos, build-sdist]
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to_pypi == 'true')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: List all packages
        run: |
          echo "========================================="
          echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒçš„æ‰€æœ‰åŒ…ï¼š"
          echo "========================================="
          ls -lh dist/
          echo ""
          echo "========================================="
          echo "ğŸ“‹ åŒ…åˆ—è¡¨ï¼š"
          echo "========================================="
          for file in dist/*; do
            echo "  âœ“ $(basename $file)"
          done
          echo ""
          echo "========================================="

      - name: Publish to PyPI
        uses: PyO3/maturin-action@v1
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        with:
          command: upload
          args: --non-interactive --skip-existing dist/*

      - name: Success message
        run: |
          echo "========================================="
          echo "âœ… å‘å¸ƒæˆåŠŸï¼"
          echo "========================================="
          echo "ç”¨æˆ·ç°åœ¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š"
          echo "  pip install never_primp"
          echo ""
          echo "æŸ¥çœ‹é¡¹ç›®ï¼š"
          echo "  https://pypi.org/project/never_primp/"
          echo "========================================="

  # ==================== ä»…æ„å»ºä¸å‘å¸ƒ ====================
  show-artifacts:
    name: Show Build Artifacts
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos, build-sdist]
    if: |
      (github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to_pypi == 'false')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: Show build results
        run: |
          echo "========================================="
          echo "âœ… æ‰€æœ‰å¹³å°æ„å»ºæˆåŠŸï¼"
          echo "========================================="
          echo ""
          echo "ğŸ“¦ æ„å»ºçš„åŒ…ï¼š"
          ls -lh dist/
          echo ""
          echo "========================================="
          echo "ğŸ“‹ å¹³å°æ”¯æŒï¼š"
          echo "========================================="
          for file in dist/*.whl; do
            echo "  âœ“ $(basename $file)"
          done
          echo ""
          echo "========================================="
          echo "ğŸ“¥ ä¸‹è½½è¯´æ˜ï¼š"
          echo "========================================="
          echo "1. åœ¨ Actions é¡µé¢ä¸‹è½½ 'all-wheels' artifact"
          echo "2. æ‰‹åŠ¨å‘å¸ƒåˆ° PyPIï¼š"
          echo "   pip install twine"
          echo "   twine upload dist/*"
          echo ""
          echo "æˆ–è€…é‡æ–°è¿è¡Œå·¥ä½œæµå¹¶é€‰æ‹©å‘å¸ƒé€‰é¡¹"
          echo "========================================="

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-wheels
          path: dist
          retention-days: 30
